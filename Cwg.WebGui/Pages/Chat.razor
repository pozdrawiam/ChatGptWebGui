@page "/Chat"
@using Cwg.Core.Dto
@using Cwg.Core.Services

@inject IChatDbService ChatDb

<PageTitle>Chat</PageTitle>

<h3>Chats</h3>

<ul>
    @foreach (ChatInfo chat in _chats)
    {
        <li>
            @if (chat == _editingChat)
            {
                <input type="text" @bind="chat.Title" />
                <button type="button" @onclick="async () => await OnSaveChatTitleClick(chat)">Save</button>
                <button type="button" @onclick="() => OnCancelEditClick(chat)">Cancel</button>
            }
            else
            {
                @chat.Title
                <button type="button" @onclick="() => OnEditChatClick(chat)">Edit</button>
                <button type="button" @onclick="async () => await OnDeleteChatClick(chat)">Delete</button>
            }
        </li>
    }
</ul>

<button type="button" @onclick="OnNewChatClick">New chat</button>

@code {
    List<ChatInfo> _chats = [];

    ChatInfo? _editingChat = null;
    
    protected override async Task OnInitializedAsync()
    {
        _chats = (await ChatDb.GetChatsAsync()).ToList();
    }

    private async Task OnNewChatClick()
    {
        var newChat = new ChatInfo();
        
        await ChatDb.AddChatAsync(newChat);
        
        _chats.Add(newChat);
    }

    private async Task OnDeleteChatClick(ChatInfo chat)
    {
        await ChatDb.DeleteChatAsync(chat.Id);

        _chats.Remove(chat);
    }
    
    private void OnEditChatClick(ChatInfo chat)
    {
        _editingChat = chat;
    }
    
    private void OnCancelEditClick(ChatInfo chat)
    {
        _editingChat = null;
    }

    private async Task OnSaveChatTitleClick(ChatInfo chat)
    {
        _editingChat = null;
        await ChatDb.UpdateChatAsync(chat);
    }

}
